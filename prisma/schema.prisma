generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String    @id @default(uuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  journeys   Journey[]
  persona    UserPersona?
  gpsLogs    GpsLog[]
}

model Journey {
  id               String    @id @default(uuid())
  user_id          String
  user             User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  start_time       DateTime
  end_time         DateTime?
  planned_route_id String
  final_route_id   String?
  completed        Boolean   @default(false)
  created_at       DateTime  @default(now())
  events           Event[]
  legs             RouteLeg[]
  gpsLogs          GpsLog[]
}

model RouteLeg {
  id               String    @id @default(uuid())
  journey_id       String
  journey          Journey   @relation(fields: [journey_id], references: [id], onDelete: Cascade)
  location_id      String
  expected_arrival DateTime
  actual_arrival   DateTime?
  created_at       DateTime  @default(now())
}

model GpsLog {
  id         String    @id @default(uuid())
  journey_id String
  journey    Journey   @relation(fields: [journey_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  latitude   Float
  longitude  Float
  timestamp  DateTime
  created_at DateTime  @default(now())
}

model Event {
  id          String    @id @default(uuid())
  journey_id  String
  journey     Journey   @relation(fields: [journey_id], references: [id], onDelete: Cascade)
  location_id String
  event_type  EventType
  wait_time   Int
  timestamp   DateTime
  created_at  DateTime  @default(now())
}

enum EventType {
  DELAY
  IDLE
  REROUTE
}

model LocationTimeStats {
  id                 String   @id @default(uuid())
  location_id        String
  time_window        String   // e.g., "08:00-08:15"
  avg_wait_time      Float
  delay_probability  Float
  reroute_rate       Float
  failure_score      Float
  total_visits       Int      @default(0)
  last_updated       DateTime @updatedAt
  
  @@unique([location_id, time_window])
}

model Route {
  id              String   @id @default(uuid())
  name            String
  start_lat       Float
  start_lng       Float
  end_lat         Float
  end_lng         Float
  distance        Float    // in kilometers
  base_eta        Int      // in minutes
  geometry        String   // JSON string of route coordinates
  confidence      RouteConfidence?
  created_at      DateTime @default(now())
}

model RouteConfidence {
  id              String   @id @default(uuid())
  route_id        String   @unique
  route           Route    @relation(fields: [route_id], references: [id], onDelete: Cascade)
  time_window     String   // e.g., "08:00-08:15"
  on_time_prob    Float
  transfer_success Float
  crowd_stability Float
  delay_variance  Float
  last_mile_avail Float
  rci_score       Float    // 0-1, weighted average
  last_updated    DateTime @updatedAt
}

model UserPersona {
  id                 String   @id @default(uuid())
  user_id            String   @unique
  user               User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  persona_type       PersonaType
  confidence         Float    // 0-1
  rusher_score       Float    @default(0)
  safe_planner_score Float    @default(0)
  comfort_seeker_score Float   @default(0)
  explorer_score     Float    @default(0)
  last_updated       DateTime @updatedAt
}

enum PersonaType {
  RUSHER
  SAFE_PLANNER
  COMFORT_SEEKER
  EXPLORER
}

model AlertZone {
  id              String   @id @default(uuid())
  name            String
  zone_type       ZoneType
  center_lat      Float
  center_lng      Float
  radius_km       Float
  severity        Int      // 1-5
  description     String?
  time_window_start DateTime?
  time_window_end DateTime?
  active          Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
}

enum ZoneType {
  SAFETY_ADVISORY
  EMERGENCY
  TRAFFIC_HOTSPOT
  INFRASTRUCTURE_ISSUE
}

model OSINTZone {
  id                String   @id @default(uuid())
  zone_type         OSINTZoneType  // protest, congestion, health_alert, weather, infrastructure
  severity          Int      @default(1)  // 1-5, low to high
  center_lat        Float
  center_lng        Float
  radius_km         Float    @default(1.0)
  geometry          String?  // JSON polygon or circle geometry
  description       String?
  time_window_start DateTime  // When this zone becomes active
  time_window_end   DateTime  // When this zone expires
  decay_factor      Float    @default(0.1)  // How much severity decays per hour
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  @@index([time_window_start, time_window_end])
  @@index([is_active])
}

enum OSINTZoneType {
  PROTEST
  CONGESTION
  HEALTH_ALERT
  WEATHER_DISRUPTION
  INFRASTRUCTURE_ISSUE
  TRANSIT_DELAY
}
